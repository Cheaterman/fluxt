version: '3.8'

services:
    backend:
        image: cheaterman/flask
        sysctls:
            net.core.somaxconn: 1024
        volumes:
            - ./backend:/code
            - ./backend_run:/run
        environment:
            SCRIPT_NAME: $BASE_URI/api
            WSGI_MODULE: backend:app
            # 101: nginx gid
            WSGI_SOCKET_GID: 101
            TZ: Europe/Paris

    frontend:
        image: node:alpine
        working_dir: /home/node
        volumes:
            - ./frontend:/home/node
            - ./frontend_run:/run
        command: sh -c '
                (
                    rm -f /run/nuxt.sock &&
                    until [ -S /run/nuxt.sock ];
                    do
                        sleep 1;
                    done;
                    chgrp 101 /run/nuxt.sock &&
                    chmod g+w /run/nuxt.sock;
                ) &
                yarn install &&
                yarn dev
            '
            # 101: nginx gid
        environment:
            BASE_URI:
            NODE_OPTIONS: --openssl-legacy-provider
            TZ: Europe/Paris

    proxy:
        image: nginx
        depends_on:
            - backend
            - frontend
        command: >
            sh -c '
                envsubst \$$BASE_URI < /etc/nginx/nginx.conf.template > /etc/nginx/nginx.conf &&
                exec /docker-entrypoint.sh nginx -g "daemon off;"
            '
        volumes:
            - ./nginx.conf.template:/etc/nginx/nginx.conf.template:ro
            - ./proxy_run:/run
            - ./backend_run:/backend_run
            - ./frontend_run:/frontend_run
        environment:
            BASE_URI:
            TZ: Europe/Paris

# vim: se sw=4 sts=4 et:
